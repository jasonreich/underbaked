<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>SoggyBottom</title>
  
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.css" />
  
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  
  
  <style>
  html, body {
  	height: 100%;
  }

  #controls {
  	position: absolute;
  	top: 3em;
  	right: 2em;
  	width: 400px;
  	/*height: 65%;*/
  	opacity: 0.95;
  }

  #mapCanvas {
  	width: 100%;
  	height: 100%;
  }
  
  .icon {
    position: relative;
    top: -1.75em;
    height: 3em;
    opacity: 1;
    margin-right: 15px;
  }
  
  .toolbar-shift {
    position: relative;
    top: -2px;
    right: -0.5em;
  }
  
  .fileDropHover {
    background-color: #fcf8e3;
  }
  
  .fileDropAccepted {
    background-color: #dff0d8;
  }
  </style>

  <script src="/components/jquery/jquery.js"></script>
  <script src="/components/bootstrap/dist/js/bootstrap.js"></script>
  <script src="/components/moment/moment.js"></script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_v6EPnrRJXiWJbu8_3_jNvhToY6D3ogU&sensor=true&libraries=geometry"></script>

  <script>
  google.load("visualization", "1", {packages:["corechart"]});

  $(function() {
  	// Initialise Globals
  	var map = new google.maps.Map($("#mapCanvas").get(0), {
  		center: new google.maps.LatLng(-34.397, 150.644),
      zoom: 8
  	});
    var droppedFile = null;
    
    // Initialise GPX file drop
    $("#fileDropZone").on('drop', function(event) {
      event.stopPropagation();
      event.preventDefault();
      $(this).removeClass('fileDropHover');
      
      var files = event.originalEvent.dataTransfer.files;
      
      if (files.length > 0 && files[0].name.split('.').pop().toLowerCase() == "gpx") {
        $(this)
          .addClass('fileDropAccepted')
          .text('Accepted file: ' + files[0].name);
        droppedFile = files[0];
      } else {
        $("#fileDropError").show().fadeOut(5000);
        droppedFile = null;
      }
    }).on('dragover', function(event){
      event.stopPropagation();
      event.preventDefault();
    }).on('dragenter dragleave', function(event){
      event.stopPropagation();
      event.preventDefault();
      $(this).toggleClass('fileDropHover');
    });
    
    // Function for plotting new traces from GPX data
    var plotFile = function (xml) {
        var points = []
          , bounds = new google.maps.LatLngBounds()
          , chartData = [["Time", "Speed"]];

        var queue = [];
        var $xml = $(xml);
        var $trkpts = $xml.children("trk")
                    .children("trkseg").children("trkpt");
        var startTime = $trkpts.first().find("time").text()
        
        $trkpts.each(function() {
            var lat = $(this).attr("lat")
              , lng = $(this).attr("lon")
              , time = new Date($(this).find("time").text());
            
            var p = new google.maps.LatLng(lat, lng);
            bounds.extend(p);
            points.push(p);

            queue.push({p: p, time: time});

            var windowSize = 60;
            if (windowSize <= queue.length) {
                var distance = 0;
                for(var i=0; i < windowSize - 1; i++) {
                    p0 = queue[i].p;
                    p1 = queue[i+1].p;
                    distance += google.maps.geometry.spherical
                        .computeDistanceBetween(p0, p1) / 1000;
                }

                var minutes = moment(time).diff(startTime, "minutes", true);
                var old = queue.shift();
                var timeDelta = moment(time).diff(old.time, 'hours', true);

                var speed = distance / timeDelta;
                chartData.push([minutes, speed]);
            }
        });

        var poly = new google.maps.Polyline({
            path: points,
            strokeColor: "red",
            strokeOpacity: 0.7,
            strokeWeight: 4
        });

        var options = {
          theme: 'maximized',
          legend: {position: 'none'},
          vAxis: {title: 'Speed (km/h)'},
          hAxis: {title: 'Minutes'}
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(google.visualization.arrayToDataTable(chartData), options);

        poly.setMap(map);
        map.fitBounds(bounds);

        var endTime = $trkpts.last().find("time").text();

        var totalTime = moment(endTime).diff(startTime, "hours", true)
                      .toFixed(2);
        $("#traceListing").append(
            $("<tr>")
                .append($("<td>").text($xml.children("trk").children("name").text()))
                .append($("<td>").text(moment(startTime).calendar()))
                .append($("<td>").text(totalTime + " hours"))
                .append($("<td>"))
        );
        
        console.log("Done.");
    };
    
    $("#fileDropSave").click(function() {
      if (droppedFile) {
        var reader = new FileReader();
        reader.onload = function(event) {
          console.log("Start plotting file.");
          plotFile(event.target.result);
        };
        console.log("Start reading file.");
        reader.readAsText(droppedFile);
        
        $("#addTrace").modal('hide');
      }
    });
    
    /*
    $.ajax({
        type: "GET",
        url: "./my_route.gpx.BAD",
        dataType: "xml",
        success: 
    });
    */
  });
  </script>
</head>

<body>

	<div id="mapCanvas"></div>
	<div id="controls" class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">
        <img src="/components/flat-ui-official/images/icons/svg/map.svg" class="mg-thumbnail pull-left icon" alt="Map Icon" />
        &nbsp;
        <div class="btn-toolbar pull-right toolbar-shift">
          <div class="btn-group">
            <a class="btn btn-default btn-xs" data-toggle="modal" data-target="#addTrace">
              <span class="glyphicon glyphicon-plus"></span>&nbsp;
              Add trace
            </a>
            <a class="btn btn-danger btn-xs">
              <span class="glyphicon glyphicon-log-out"></span>&nbsp;
              Log out
            </a>
          </div>
        </div>
      </h3>
    </div>
	<div class="panel-body">
        <h4>Comparing rides:</h4>
	</div>
    
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Length</th>
          <th>&nbsp;</th>
        </tr>
      </thead>
      <tbody id="traceListing">
        
      </tbody>
    </table>

    <ul class="list-group">
      <li class="list-group-item">
        <div class="panel-body" id="chart_div">
        </div>
      </li>
    </ul>
    
	</div>

    <div class="modal fade" id="addTrace" tabindex="-1" role="dialog" aria-labelledby="addTraceLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="addTrace">Add New Trace</h4>
          </div>
          <div class="modal-body">
            <div id="fileDropZone" class="well">
              <p id="fileDropError" class="text-danger" style="display: none;">File not accepted. Must have GPX extension.</p>
              Drop files here
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button id="fileDropSave" type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>

</body>
</html>
    