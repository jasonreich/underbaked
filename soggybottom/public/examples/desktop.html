<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>SoggyBottom</title>
  
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.css" />
  
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  
  
  <style>
  html, body {
  	height: 100%;
  }

  #controls {
  	position: absolute;
  	top: 3em;
  	right: 2em;
  	width: 400px;
  	/*height: 65%;*/
  	opacity: 0.95;
  }

  #mapCanvas {
  	width: 100%;
  	height: 100%;
  }
  
  .icon {
    position: relative;
    top: -1.75em;
    height: 3em;
    opacity: 1;
    margin-right: 15px;
  }
  
  .toolbar-shift {
    position: relative;
    top: -2px;
    right: -0.5em;
  }
  </style>

  <script src="/components/jquery/jquery.js"></script>
  <script src="/components/bootstrap/dist/js/bootstrap.js"></script>
  <script src="/components/moment/moment.js"></script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_v6EPnrRJXiWJbu8_3_jNvhToY6D3ogU&sensor=true&libraries=geometry"></script>

  <script>
  google.load("visualization", "1", {packages:["corechart"]});

  $(function() {
  	// Initialise Google Maps
  	var mapOptions = {
  		center: new google.maps.LatLng(-34.397, 150.644),
        zoom: 8
  	}
  	var map = new google.maps.Map($("#mapCanvas").get(0), mapOptions);

    $.ajax({
        type: "GET",
        url: "./my_route.gpx",
        dataType: "xml",
        success: function (xml) {
            var points = []
              , bounds = new google.maps.LatLngBounds()
              , chartData = [["Time", "Speed"]];

            var queue = [];
            $(xml).find("trkpt").each(function() {
                var lat = $(this).attr("lat")
                  , lng = $(this).attr("lon")
                  , time = new Date($(this).find("time").text());
                
                var p = new google.maps.LatLng(lat, lng);
                bounds.extend(p);
                points.push(p);

                queue.push({p: p, time: time});

                var windowSize = 60;
                if (windowSize <= queue.length) {
                    var distance = 0;
                    for(var i=0; i < windowSize - 1; i++) {
                        p0 = queue[i].p;
                        p1 = queue[i+1].p;
                        distance += google.maps.geometry.spherical
                            .computeDistanceBetween(p0, p1) / 1000;
                    }

                    var old = queue.shift();
                    var timeDelta = moment(time).diff(old.time, 'hours', true);

                    var speed = distance / timeDelta;
                    chartData.push([time, speed]);
                }
            });

            var poly = new google.maps.Polyline({
                path: points,
                strokeColor: "blue",
                strokeOpacity: 0.7,
                strokeWeight: 4
            });

            var options = {
              theme: 'maximized',
              legend: {position: 'none'},
              vAxis: {title: 'Speed (km/h)'},
              hAxis: {title: 'Time'}
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(google.visualization.arrayToDataTable(chartData), options);

            poly.setMap(map);
            map.fitBounds(bounds);

            var startTime = $(xml).find("trkpt").first().find("time").text()
              , endTime   = $(xml).find("trkpt").last().find("time").text();

            var totalTime = moment(endTime).diff(startTime, "hours", true);
            $("#traceListing").append(
                $("<tr>")
                    .append($("<td>").text($(xml).find("name").text()))
                    .append($("<td>").text(moment(startTime).calendar()))
                    .append($("<td>").text(totalTime + " hours"))
                    .append($("<td>"))
            );
        }
    });
  });
  </script>
</head>

<body>

	<div id="mapCanvas"></div>
	<div id="controls" class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">
        <img src="/components/flat-ui-official/images/icons/svg/map.svg" class="mg-thumbnail pull-left icon" alt="Map Icon" />
        &nbsp;
        <div class="btn-toolbar pull-right toolbar-shift">
          <div class="btn-group">
            <a class="btn btn-default btn-xs" data-toggle="modal" data-target="#addTrace">
              <span class="glyphicon glyphicon-plus"></span>&nbsp;
              Add trace
            </a>
            <a class="btn btn-danger btn-xs">
              <span class="glyphicon glyphicon-log-out"></span>&nbsp;
              Log out
            </a>
          </div>
        </div>
      </h3>
    </div>
	<div class="panel-body">
        <h4>Comparing rides:</h4>
	</div>
    
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Length</th>
          <th>&nbsp;</th>
        </tr>
      </thead>
      <tbody id="traceListing">
        
      </tbody>
    </table>

    <ul class="list-group">
      <li class="list-group-item">
        <div class="panel-body" id="chart_div">
        </div>
      </li>
    </ul>
    
	</div>

    <div class="modal fade" id="addTrace" tabindex="-1" role="dialog" aria-labelledby="addTraceLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="addTrace">Add New Trace</h4>
          </div>
          <div class="modal-body">
            Blah
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>

</body>
</html>
    